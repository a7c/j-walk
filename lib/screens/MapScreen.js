Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _class,_temp,_jsxFileName='src/screens/MapScreen.js';var _expo=require('expo');var _react=require('react');var _react2=_interopRequireDefault(_react);var _reactNative=require('react-native');var _reactNavigation=require('react-navigation');var _VenueFetcher=require('src/async/VenueFetcher');var _Types=require('src/entities/Types');var _VocabEngine=require('src/entities/VocabEngine');var _VenueMarker=require('src/components/map/VenueMarker');var _VenueMarker2=_interopRequireDefault(_VenueMarker);var _GameStore=require('src/undux/GameStore');var _Util=require('src/Util');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var getDistanceFromLatLng=function getDistanceFromLatLng(coords1,coords2){var lat1=coords1.latitude;var lon1=coords1.longitude;var lat2=coords2.latitude;var lon2=coords2.longitude;var p=0.017453292519943295;var c=Math.cos;var a=0.5-c((lat2-lat1)*p)/2+c(lat1*p)*c(lat2*p)*(1-c((lon2-lon1)*p))/2;return 12742*Math.asin(Math.sqrt(a))*1000;};var GEOLOCATION_OPTIONS={enableHighAccuracy:true,timeInterval:2000,distanceInterval:1};var LATITUDE_DELTA=0.002;var LONGITUDE_DELTA=0.002;var MapScreen=(_temp=_class=function(_React$Component){_inherits(MapScreen,_React$Component);function MapScreen(props){var _this2=this;_classCallCheck(this,MapScreen);var _this=_possibleConstructorReturn(this,(MapScreen.__proto__||Object.getPrototypeOf(MapScreen)).call(this,props));_this._headingSubscription=null;_this._pendingPromises=[];_this._positionSubscription=null;_this._addPromise=function(promise){_this._pendingPromises=[].concat(_toConsumableArray(_this._pendingPromises),[promise]);};_this._removePromise=function(promise){_this._pendingPromises=_this._pendingPromises.filter(function(p){return p!==promise;});};_this._wrapPromise=function(promise){var wrappedPromise=(0,_Util.cancellablePromise)(promise);_this._pendingPromises=[].concat(_toConsumableArray(_this._pendingPromises),[wrappedPromise]);return wrappedPromise.promise.finally(function(_){_this._pendingPromises=_this._pendingPromises.filter(function(p){return p!==wrappedPromise;});return promise;});};_this._onLocationChanged=function(location){_this.setState({playerPos:{latitude:location.coords.latitude,longitude:location.coords.longitude}});};_this._onHeadingChanged=function(heading){_this.setState({playerHeading:heading.magHeading});};_this._populateMap=function _callee(){var store,region,venues,venuesById,nearbyVenues,_iterator,_isArray,_i,_ref,venue,vocabById,vocabFromKeyword,_iterator2,_isArray2,_i2,_ref2,_venue,keywords,_iterator3,_isArray3,_i3,_ref3,keyword,vocabCandidates,vocabEntries,_iterator4,_isArray4,_i4,_ref4,vocabEntry,vocabForVenue;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:store=_this.props.store;region=_this.state.region;_this.setState({isLoading:true});_context.next=5;return regeneratorRuntime.awrap(_this._wrapPromise((0,_VenueFetcher.fetchVenues)(region.latitude,region.longitude,250)));case 5:venues=_context.sent;venuesById=new Map(store.get('venuesById'));nearbyVenues=new Set();_iterator=venues,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==='function'?typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator':'@@iterator']();case 9:if(!_isArray){_context.next=15;break;}if(!(_i>=_iterator.length)){_context.next=12;break;}return _context.abrupt('break',24);case 12:_ref=_iterator[_i++];_context.next=19;break;case 15:_i=_iterator.next();if(!_i.done){_context.next=18;break;}return _context.abrupt('break',24);case 18:_ref=_i.value;case 19:venue=_ref;if(!venuesById.has(venue.id)){venuesById.set(venue.id,venue);}nearbyVenues.add(venue.id);case 22:_context.next=9;break;case 24:store.set('venuesById')(venuesById);store.set('nearbyVenues')(nearbyVenues);_this.setState({isLoading:false});vocabById=new Map(store.get('vocabById'));vocabFromKeyword=new Map(store.get('vocabFromKeyword'));_iterator2=venues,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==='function'?typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator':'@@iterator']();case 30:if(!_isArray2){_context.next=36;break;}if(!(_i2>=_iterator2.length)){_context.next=33;break;}return _context.abrupt('break',89);case 33:_ref2=_iterator2[_i2++];_context.next=40;break;case 36:_i2=_iterator2.next();if(!_i2.done){_context.next=39;break;}return _context.abrupt('break',89);case 39:_ref2=_i2.value;case 40:_venue=_ref2;_context.next=43;return regeneratorRuntime.awrap(_this._wrapPromise((0,_VocabEngine.generateKeywordsForVenueCategory)(venuesById,_venue.id)));case 43:keywords=_context.sent;_iterator3=keywords,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==='function'?typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator':'@@iterator']();case 45:if(!_isArray3){_context.next=51;break;}if(!(_i3>=_iterator3.length)){_context.next=48;break;}return _context.abrupt('break',87);case 48:_ref3=_iterator3[_i3++];_context.next=55;break;case 51:_i3=_iterator3.next();if(!_i3.done){_context.next=54;break;}return _context.abrupt('break',87);case 54:_ref3=_i3.value;case 55:keyword=_ref3;vocabCandidates=vocabFromKeyword.get(keyword);if(vocabCandidates){_context.next=78;break;}_context.next=60;return regeneratorRuntime.awrap(_this._wrapPromise((0,_VocabEngine.generateVocabForKeyword)(keyword)));case 60:vocabEntries=_context.sent;_iterator4=vocabEntries,_isArray4=Array.isArray(_iterator4),_i4=0,_iterator4=_isArray4?_iterator4:_iterator4[typeof Symbol==='function'?typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator':'@@iterator']();case 62:if(!_isArray4){_context.next=68;break;}if(!(_i4>=_iterator4.length)){_context.next=65;break;}return _context.abrupt('break',76);case 65:_ref4=_iterator4[_i4++];_context.next=72;break;case 68:_i4=_iterator4.next();if(!_i4.done){_context.next=71;break;}return _context.abrupt('break',76);case 71:_ref4=_i4.value;case 72:vocabEntry=_ref4;if(!vocabById.has(vocabEntry.id)){vocabById.set(vocabEntry.id,vocabEntry);}case 74:_context.next=62;break;case 76:vocabCandidates=vocabEntries.map(function(entry){return entry.id;});vocabFromKeyword.set(keyword,vocabCandidates);case 78:vocabForVenue=vocabCandidates.pop();if(vocabForVenue){_context.next=81;break;}return _context.abrupt('continue',85);case 81:_venue.vocab=vocabForVenue;_venue.state=_Types.VenueState.LEARN;store.set('venuesById')(new Map(venuesById));return _context.abrupt('break',87);case 85:_context.next=45;break;case 87:_context.next=30;break;case 89:store.set('vocabById')(vocabById);store.set('vocabFromKeyword')(vocabFromKeyword);case 91:case'end':return _context.stop();}}},null,_this2);};_this._onRegionChangeComplete=function(region){_this.setState({region:region});};_this._getLocationAsync=function _callee2(callback){var _ref5,status,location;return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return regeneratorRuntime.awrap(_this._wrapPromise(_expo.Permissions.askAsync(_expo.Permissions.LOCATION)));case 2:_ref5=_context2.sent;status=_ref5.status;if(status!=='granted'){_this.setState({errorMessage:'Permission to access location was denied'});}_context2.next=7;return regeneratorRuntime.awrap(_this._wrapPromise(_expo.Location.getCurrentPositionAsync({})));case 7:location=_context2.sent;_this.setState({playerPos:{latitude:location.coords.latitude,longitude:location.coords.longitude}});_this.setState({region:{latitude:location.coords.latitude,longitude:location.coords.longitude,latitudeDelta:LATITUDE_DELTA,longitudeDelta:LONGITUDE_DELTA}});_context2.next=12;return regeneratorRuntime.awrap(_this._wrapPromise(callback()));case 12:case'end':return _context2.stop();}}},null,_this2);};_this.state={region:{latitude:42.444782,longitude:-76.484187,latitudeDelta:0.00287,longitudeDelta:0.00131},isLoading:false,errorMessage:'',playerPos:{latitude:0,longitude:0},playerHeading:0};_expo.Location.watchPositionAsync({enableHighAccuracy:true,timeInterval:2000,distanceInterval:1},_this._onLocationChanged).then(function(subscription){return _this._positionSubscription=subscription;});_expo.Location.watchHeadingAsync(_this._onHeadingChanged).then(function(subscription){return _this._headingSubscription=subscription;});return _this;}_createClass(MapScreen,[{key:'componentDidMount',value:function componentDidMount(){try{this._getLocationAsync(this._populateMap);}catch(error){console.error(error);}}},{key:'componentWillUnmount',value:function componentWillUnmount(){this._pendingPromises.map(function(p){return p.cancel();});if(this._positionSubscription){this._positionSubscription.remove();}if(this._headingSubscription){this._headingSubscription.remove();}}},{key:'render',value:function render(){var _props=this.props,navigation=_props.navigation,store=_props.store;var _state=this.state,isLoading=_state.isLoading,region=_state.region;return _react2.default.createElement(_reactNative.View,{style:styles.container,__source:{fileName:_jsxFileName,lineNumber:272}},_react2.default.createElement(_expo.MapView,{style:styles.map,region:region,onRegionChangeComplete:this._onRegionChangeComplete,__source:{fileName:_jsxFileName,lineNumber:273}},Array.from(store.get('nearbyVenues')).map(function(venueId){return _react2.default.createElement(_VenueMarker2.default,{venueId:venueId,key:venueId,__source:{fileName:_jsxFileName,lineNumber:279}});}),_react2.default.createElement(_expo.MapView.Marker,{coordinate:this.state.playerPos,pointerEvents:'none',__source:{fileName:_jsxFileName,lineNumber:281}},_react2.default.createElement(_reactNative.Image,{source:require('assets/images/map/mon.png'),resizeMode:_reactNative.Image.resizeMode.cover,style:{width:47,height:40,zIndex:1},__source:{fileName:_jsxFileName,lineNumber:285}}),_react2.default.createElement(_reactNative.Image,{source:require('assets/images/map/bearingV2.png'),resizeMode:_reactNative.Image.resizeMode.cover,style:{width:90,height:90,zIndex:0,position:'absolute',top:-24,left:-21,transform:[{rotate:String(this.state.playerHeading)+'deg'}]},__source:{fileName:_jsxFileName,lineNumber:294}}))),_react2.default.createElement(_reactNative.View,{style:styles.header,__source:{fileName:_jsxFileName,lineNumber:311}},_react2.default.createElement(_reactNative.TouchableOpacity,{style:styles.backButton,onPress:function onPress(){return navigation.dispatch(_reactNavigation.NavigationActions.back());},__source:{fileName:_jsxFileName,lineNumber:312}},_react2.default.createElement(_reactNative.Image,{source:require('assets/images/text/home.png'),__source:{fileName:_jsxFileName,lineNumber:316}}))),_react2.default.createElement(_reactNative.View,{style:styles.loading,__source:{fileName:_jsxFileName,lineNumber:319}},_react2.default.createElement(_reactNative.ActivityIndicator,{animating:isLoading,size:'large',color:'#FF8859',__source:{fileName:_jsxFileName,lineNumber:320}})));}}]);return MapScreen;}(_react2.default.Component),_class.navigationOptions={title:'Map',header:{visible:false},gesturesEnabled:false},_temp);exports.default=(0,_GameStore.withStore)(MapScreen);var styles=_reactNative.StyleSheet.create({container:_extends({},_reactNative.StyleSheet.absoluteFillObject,{flex:1,justifyContent:'flex-end',alignItems:'center'}),map:_extends({},_reactNative.StyleSheet.absoluteFillObject),loading:{position:'absolute',top:'25%',flexDirection:'row',justifyContent:'space-around',padding:10},callout:{width:140},bubble:{backgroundColor:'rgba(255,255,255,0.7)',paddingHorizontal:18,paddingVertical:12,borderRadius:20},latlng:{width:200,alignItems:'stretch'},button:{width:80,paddingHorizontal:12,alignItems:'center',marginHorizontal:10},buttonContainer:{flexDirection:'row',marginVertical:20,backgroundColor:'transparent'},houseClick:{color:'black'},backButton:{width:70,height:30},refreshButton:{width:204,height:53},header:{top:'-90%',marginRight:'60%'}});