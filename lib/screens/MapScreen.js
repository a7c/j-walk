Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _class,_temp,_jsxFileName='src/screens/MapScreen.js';var _expo=require('expo');var _react=require('react');var _react2=_interopRequireDefault(_react);var _reactNative=require('react-native');var _reactNavigation=require('react-navigation');var _VenueFetcher=require('src/async/VenueFetcher');var _VocabEngine=require('src/entities/VocabEngine');var _VenueMarker=require('src/map/VenueMarker');var _VenueMarker2=_interopRequireDefault(_VenueMarker);var _GameStore=require('src/undux/GameStore');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var getDistanceFromLatLng=function getDistanceFromLatLng(coords1,coords2){var lat1=coords1.latitude;var lon1=coords1.longitude;var lat2=coords2.latitude;var lon2=coords2.longitude;var p=0.017453292519943295;var c=Math.cos;var a=0.5-c((lat2-lat1)*p)/2+c(lat1*p)*c(lat2*p)*(1-c((lon2-lon1)*p))/2;return 12742*Math.asin(Math.sqrt(a))*1000;};var MapScreen=(_temp=_class=function(_React$Component){_inherits(MapScreen,_React$Component);function MapScreen(props){_classCallCheck(this,MapScreen);var _this=_possibleConstructorReturn(this,(MapScreen.__proto__||Object.getPrototypeOf(MapScreen)).call(this,props));_this._onRegionChangeComplete=function(region){_this.setState({region:region});};_this.state={region:{latitude:42.444782,longitude:-76.484187,latitudeDelta:0.00287,longitudeDelta:0.00131},isLoading:false};return _this;}_createClass(MapScreen,[{key:'componentDidMount',value:function componentDidMount(){try{this._populateMap();}catch(error){console.error(error);}}},{key:'_populateMap',value:function _populateMap(){var store,region,venues,venuesById,nearbyVenues,_iterator,_isArray,_i,_ref,venue,vocabById,vocabFromKeyword,_iterator2,_isArray2,_i2,_ref2,_venue,keywords,_iterator3,_isArray3,_i3,_ref3,keyword,vocabCandidates,vocabEntries,_iterator4,_isArray4,_i4,_ref4,vocabEntry,vocabForVenue;return regeneratorRuntime.async(function _populateMap$(_context){while(1){switch(_context.prev=_context.next){case 0:store=this.props.store;region=this.state.region;this.setState({isLoading:true});_context.next=5;return regeneratorRuntime.awrap((0,_VenueFetcher.fetchVenues)(region.latitude,region.longitude,250));case 5:venues=_context.sent;venuesById=new Map(store.get('venuesById'));nearbyVenues=new Set();_iterator=venues,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator']();case 9:if(!_isArray){_context.next=15;break;}if(!(_i>=_iterator.length)){_context.next=12;break;}return _context.abrupt('break',24);case 12:_ref=_iterator[_i++];_context.next=19;break;case 15:_i=_iterator.next();if(!_i.done){_context.next=18;break;}return _context.abrupt('break',24);case 18:_ref=_i.value;case 19:venue=_ref;if(!venuesById.has(venue.id)){venuesById.set(venue.id,venue);}nearbyVenues.add(venue.id);case 22:_context.next=9;break;case 24:store.set('venuesById')(venuesById);store.set('nearbyVenues')(nearbyVenues);this.setState({isLoading:false});vocabById=new Map(store.get('vocabById'));vocabFromKeyword=new Map(store.get('vocabFromKeyword'));_iterator2=venues,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator']();case 30:if(!_isArray2){_context.next=36;break;}if(!(_i2>=_iterator2.length)){_context.next=33;break;}return _context.abrupt('break',89);case 33:_ref2=_iterator2[_i2++];_context.next=40;break;case 36:_i2=_iterator2.next();if(!_i2.done){_context.next=39;break;}return _context.abrupt('break',89);case 39:_ref2=_i2.value;case 40:_venue=_ref2;_context.next=43;return regeneratorRuntime.awrap((0,_VocabEngine.generateKeywordsForVenueCategory)(venuesById,_venue.id));case 43:keywords=_context.sent;_iterator3=keywords,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator']();case 45:if(!_isArray3){_context.next=51;break;}if(!(_i3>=_iterator3.length)){_context.next=48;break;}return _context.abrupt('break',87);case 48:_ref3=_iterator3[_i3++];_context.next=55;break;case 51:_i3=_iterator3.next();if(!_i3.done){_context.next=54;break;}return _context.abrupt('break',87);case 54:_ref3=_i3.value;case 55:keyword=_ref3;console.log('keyword: '+keyword);vocabCandidates=vocabFromKeyword.get(keyword);if(vocabCandidates){_context.next=79;break;}_context.next=61;return regeneratorRuntime.awrap((0,_VocabEngine.generateVocabForKeyword)(keyword));case 61:vocabEntries=_context.sent;_iterator4=vocabEntries,_isArray4=Array.isArray(_iterator4),_i4=0,_iterator4=_isArray4?_iterator4:_iterator4[typeof Symbol==='function'?typeof Symbol==='function'?Symbol.iterator:'@@iterator':'@@iterator']();case 63:if(!_isArray4){_context.next=69;break;}if(!(_i4>=_iterator4.length)){_context.next=66;break;}return _context.abrupt('break',77);case 66:_ref4=_iterator4[_i4++];_context.next=73;break;case 69:_i4=_iterator4.next();if(!_i4.done){_context.next=72;break;}return _context.abrupt('break',77);case 72:_ref4=_i4.value;case 73:vocabEntry=_ref4;if(!vocabById.has(vocabEntry.id)){vocabById.set(vocabEntry.id,vocabEntry);}case 75:_context.next=63;break;case 77:vocabCandidates=vocabEntries.map(function(entry){return entry.id;});vocabFromKeyword.set(keyword,vocabCandidates);case 79:console.log(vocabCandidates);vocabForVenue=vocabCandidates.pop();if(vocabForVenue){_context.next=83;break;}return _context.abrupt('continue',85);case 83:_venue.vocab=vocabForVenue;return _context.abrupt('break',87);case 85:_context.next=45;break;case 87:_context.next=30;break;case 89:store.set('vocabById')(vocabById);store.set('vocabFromKeyword')(vocabFromKeyword);console.log(venues);case 92:case'end':return _context.stop();}}},null,this);}},{key:'render',value:function render(){var _props=this.props,navigation=_props.navigation,store=_props.store;var _state=this.state,isLoading=_state.isLoading,region=_state.region;return _react2.default.createElement(_reactNative.View,{style:styles.container,__source:{fileName:_jsxFileName,lineNumber:163}},_react2.default.createElement(_expo.MapView,{style:styles.map,region:region,onRegionChangeComplete:this._onRegionChangeComplete,__source:{fileName:_jsxFileName,lineNumber:164}},Array.from(store.get('nearbyVenues')).map(function(venueId){return _react2.default.createElement(_VenueMarker2.default,{venueId:venueId,key:venueId,__source:{fileName:_jsxFileName,lineNumber:170}});})),_react2.default.createElement(_reactNative.View,{style:styles.header,__source:{fileName:_jsxFileName,lineNumber:173}},_react2.default.createElement(_reactNative.TouchableOpacity,{style:styles.backButton,onPress:function onPress(){return navigation.dispatch(_reactNavigation.NavigationActions.back());},__source:{fileName:_jsxFileName,lineNumber:174}},_react2.default.createElement(_reactNative.Image,{source:require('assets/images/text/home.png'),__source:{fileName:_jsxFileName,lineNumber:178}}))),_react2.default.createElement(_reactNative.ActivityIndicator,{animating:isLoading,__source:{fileName:_jsxFileName,lineNumber:181}}));}}]);return MapScreen;}(_react2.default.Component),_class.navigationOptions={title:'Map',header:null,gesturesEnabled:false},_temp);exports.default=(0,_GameStore.withStore)(MapScreen);var styles=_reactNative.StyleSheet.create({container:_extends({},_reactNative.StyleSheet.absoluteFillObject,{flex:1,justifyContent:'flex-end',alignItems:'center'}),map:_extends({},_reactNative.StyleSheet.absoluteFillObject),callout:{width:140},bubble:{backgroundColor:'rgba(255,255,255,0.7)',paddingHorizontal:18,paddingVertical:12,borderRadius:20},latlng:{width:200,alignItems:'stretch'},button:{width:80,paddingHorizontal:12,alignItems:'center',marginHorizontal:10},buttonContainer:{flexDirection:'row',marginVertical:20,backgroundColor:'transparent'},houseClick:{color:'black'},backButton:{width:70,height:30},refreshButton:{width:204,height:53},header:{marginBottom:'150%',marginRight:'60%'}});